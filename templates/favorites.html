<!DOCTYPE html>
<html>
  <head>
    <title>My Favorites - World News Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <style>
      /* Same CSS as index.html */
      body { background: #f2f2f2; font-size: 16px; }
      .news-card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 5px solid #007bff; word-wrap: break-word; }
      details summary { cursor: pointer; font-weight: bold; }
      .navbar-brand { font-size: 1.2rem; }
      .nav-link { font-size: 1rem; }
      .container { padding: 0 15px; }
      #loadMore { font-size: 1rem; }
      @media (max-width: 768px) {
        .navbar-brand { font-size: 1rem; }
        .nav-link { font-size: 0.9rem; }
        .news-card { padding: 12px; font-size: 0.95rem; }
      }
      @media (max-width: 480px) {
        .navbar-brand { font-size: 0.95rem; }
        .nav-link { font-size: 0.85rem; }
        .news-card { padding: 10px; font-size: 0.9rem; }
      }
    </style>
  </head>

  <body>
    <!-- Navbar (same as index) -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="#">Real-time News Detection</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('index') }}">Home</a>
            </li>
            {% if session.get('user') %}
            <li class="nav-item">
              <a class="nav-link active" href="{{ url_for('favorites') }}">Favorites</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
            </li>
            {% else %}
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('auth_page') }}">Login</a>
            </li>
            {% endif %}
          </ul>
        </div>
      </div>
    </nav>

    {% if session.get('user') %}
    <div class="container mt-2 p-2 bg-light rounded shadow-sm d-flex justify-content-between align-items-center">
      <strong>Hi, {{ session['user']['username'] }} ({{ session['user']['email'] }})</strong>
      <span id="currentDateTime"></span>
    </div>
    <script>
      function updateDateTime() {
        const now = new Date();
        const options = { weekday: "long", year: "numeric", month: "long", day: "numeric", hour: "2-digit", minute: "2-digit", second: "2-digit" };
        document.getElementById("currentDateTime").textContent = now.toLocaleDateString("en-US", options);
      }
      updateDateTime();
      setInterval(updateDateTime, 1000);
    </script>
    {% endif %}

    <div class="container mt-4">
      <h2 class="mb-4">‚ù§Ô∏è My Favorites</h2>
      <div id="newsList"></div>
    </div>

    <script>
      // Load favorites from backend
      async function loadFavorites() {
        const res = await fetch(`/get_favorites?email={{ session['user']['email'] }}`);
        const data = await res.json();
        const list = document.getElementById("newsList");
        list.innerHTML = "";

        data.forEach((n) => {
          const card = document.createElement("div");
          card.className = "news-card";

          card.dataset.title = n.title;
          card.dataset.summary = n.summary;
          card.dataset.text = n.text;
          card.dataset.gemini_percent = n.gemini_percent;
          card.dataset.model_label = n.model_label;
          card.dataset.publish_date = n.publish_date;
          card.dataset.country = n.country;
          card.dataset.url = n.url;

          card.innerHTML = `
<h5 style="display: flex; justify-content: space-between; align-items: center;">
  ${n.title}
  <span class="card-icons">
    <span class="heart-icon" style="cursor:pointer; color:red;">‚ù§Ô∏è</span>
    <span class="speaker-icon" style="cursor:pointer;">üîä</span>
  </span>
</h5>

<small class="text-muted">${n.country} | ${new Date(n.publish_date).toLocaleString("en-IN")}</small>

<details class="mt-2">
  <summary>Show Description</summary>
  <p class="mt-2"><strong>Summary:</strong> ${n.summary}</p>
  <p><strong>Full Text:</strong><br>${n.text}</p>
  ${n.url ? `<a href="${n.url}" target="_blank">Read full article ‚Üí</a>` : ""}
</details>
<div class="ai-result mt-2 fw-bold"></div>
          `;
          list.appendChild(card);
        });
      }

      loadFavorites();

      // TTS and favorite toggle same as index
      let currentUtterance = null;
      document.addEventListener("click", function (e) {
        const card = e.target.closest(".news-card");
        if (!card) return;

        if (e.target.classList.contains("speaker-icon")) {
          const textToSpeak = `${card.dataset.title}. ${card.dataset.summary}. ${card.dataset.text}`;
          if (currentUtterance) {
            speechSynthesis.cancel();
            document.querySelectorAll(".speaker-icon").forEach(icon => icon.textContent="üîä");
            if (currentUtterance.card === card) { currentUtterance=null; return; }
          }
          const utterance = new SpeechSynthesisUtterance(textToSpeak);
          currentUtterance={ utterance, card };
          e.target.textContent="‚è∏Ô∏è";
          utterance.onend = ()=>{ e.target.textContent="üîä"; currentUtterance=null; }
          speechSynthesis.speak(utterance);
        }

        if (e.target.classList.contains("heart-icon")) {
          alert("Already marked favorite"); // Favorites page, hearts are red
        }
      });
    </script>
  </body>
</html>
